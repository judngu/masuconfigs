#!/usr/bin/env ruby

require 'tempfile'

file=ARGV[0]
stdout=ARGV[1].nil? ? false : true

if File.exist?(file)
	lines = `git shortlog -sn #{file}`.split("\n")
else
	lines = []
	error_message = "-- <tt>#{file}</tt> does not exist"
end

output = ""

numbers_to_authors={}
numbers_and_authors = []
lines.each do | l |
	cleaned = l.strip
	next unless cleaned.length > 0
	items = cleaned.split(' ')
	num = items[0].to_i
	name = items[1..-1].join(' ')
	numbers_and_authors.push( [num, name])
end
sum = numbers_and_authors.map{|arr| arr[0]}.reduce(:+)

header=<<EOL
	<html>
		<head>
			<title>git who</title>
			<style>
*, *:before, *:after {
  -moz-box-sizing: border-box; -webkit-box-sizing: border-box; box-sizing: border-box;
 }

body {
  background: #999;
}

h2 {
  margin: 0 0 20px 0;
  padding: 0 0 5px 0;
  border-bottom: 1px solid #999;
  font-family: sans-serif;
  font-weight: normal;
  color: #333;
}

.container {
  min-width: 500px;
  margin: 20px;
  background: #fff;
  padding: 20px;
  overflow: hidden;
  float: left;
}

.horizontal .progress-bar {
  float: left;
  height: 22px;
  width: 100%;
  padding: 12px 0;
}

.horizontal .progress-track {
  position: relative;
  width: 100%;
  height: 20px;
  background: #ebebeb;
}

.horizontal .progress-fill {
  position: relative;
  background: #f4a261;
  height: 20px;
  width: 50%;
  color: #343436;
  font-weight: bold;
  text-align: center;
  font-family: "Lato","Verdana",sans-serif;
  font-size: 12px;
  line-height: 20px;
}

.rounded .progress-track,
.rounded .progress-fill {
  border-radius: 3px;
  box-shadow: inset 0 0 5px rgba(0,0,0,.2);
}


.rounded .progress-track,
.rounded .progress-fill {
  box-shadow: inset 0 0 5px rgba(0,0,0,.2);
  border-radius: 3px;
}
.author{
	white-space: nowrap;
	padding-left: 1rem;
}
.heading{
	font-size: 2rem;
	font-weight: bold;
}
.commits{
	display: none;
	font-family: monospace;
}
.commits ul {
	margin-bottom: 0px;
}
.treeish{
	white-space: pre;
}
input[type=checkbox] {
	display: none;
}
input[type=checkbox]:checked ~ .commits {
	display: inline-block;
}
			</style>

		</head>
		<body>
			<div class="heading">
				#{sum} Commits on
				<br /><tt>#{file}</tt>
				#{error_message}
			</div>
			<div class="container horizontal rounded">
EOL

output += header

numbers_and_authors.sort_by{|arr|arr[0]}.reverse.each do | arr |
	num = arr[0]
	percent = (100*num/sum)
	id= "#{arr[0]}-#{arr[1].gsub(/\s+/, '_')}"
bar=<<EOL
  <div>
  <input type="checkbox" id="#{id}">
  <label for="#{id}">
  <div class="progress-bar horizontal">
    <div class="progress-track">
      <div class='progress-fill' style='width: #{percent}%;'>
        <span>#{num}</span><span class='author'>#{arr[1]}</span>
      </div>
    </div>
  </div>
  </label>
EOL
	output += bar
	commits = `git log --oneline --author "#{arr[1]}" #{file}`.split(/\n/)
	commits = commits.map{|c|c.strip.sub(/^(\w+)/, "<span class='treeish'>\\1</span>")}
	
	output +=<<EOL
		<div class='commits'>
			<ul>
				<li>#{commits.join("</li><li>")[0..-5]}
			</ul>
		</div>
	</div>
EOL
end

footer=<<EOL
			</div>
		</body>
	</html>
EOL

output += footer

if ! stdout 
	t = Tempfile.new("git_who_f")
	t.write(output)
	t.close()

	`fenestro -p #{t.path} -n "git_who"`
	t.unlink()
else
	puts output
end

